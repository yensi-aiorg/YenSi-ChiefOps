name: chiefops

services:
  # ─────────────────────────────────────────────
  # Frontend — React 19 / Vite (dev server + HMR)
  # ─────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "23100:23100"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/index.html:/app/index.html
    environment:
      - VITE_API_URL=http://localhost:23101
      - VITE_WS_URL=ws://localhost:23101
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      chiefops-mongo:
        condition: service_healthy

  # ─────────────────────────────────────────────
  # MongoDB 8 — Primary datastore
  # ─────────────────────────────────────────────
  chiefops-mongo:
    image: mongo:8
    ports:
      - "23102:27017"
    volumes:
      - chiefops-mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────────
  # Redis — Caching + pub/sub
  # ─────────────────────────────────────────────
  chiefops-redis:
    image: redis:7-alpine
    ports:
      - "23103:6379"
    volumes:
      - chiefops-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  chiefops-mongo-data:
  chiefops-redis-data:
